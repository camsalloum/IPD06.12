# Budget Export HTML Sync Guide

## Overview
The Budget tab has TWO versions:
1. **Live Version** (React): `src/components/MasterData/AEBF/BudgetTab.js`
2. **Export Version** (HTML): Generated by `server/routes/aebf.js` endpoint `/export-html-budget-form`

**IMPORTANT**: When you add features to the Live Version, you MUST also update the Export HTML template!

## Recent Features Added to Both Versions

### ✅ Completed Features (Nov 22, 2025)
1. **Dynamic Legend with Years**
   - Live: Shows "Actual Volume 2025 (MT)" and "Budget Volume 2026 (MT)"
   - Export: Updated to show dynamic years using template literals

2. **Searchable Dropdowns**
   - Live: Uses Ant Design Select with `showSearch` and `filterOption`
   - Export: Added `makeSelectSearchable()` JavaScript function for keyboard search

3. **Delete Budget Button**
   - Live: DELETE button calls `/api/budget-draft/delete-final/:division/:salesRep/:budgetYear`
   - Export: NOT ADDED (HTML file is offline, can't delete from database)

4. **Disabled Country/Product Until Customer Entered**
   - Live: Uses `disabled={!customRow.customer}` prop
   - Export: Updated `updateInputStates()` function to disable dropdowns

5. **Zero Value Submission**
   - Live: Validation changed from `>0` to `>=0`
   - Export: Already supports zero values (no validation)

6. **New Customer Input with Direct Typing**
   - Live: Uses `mode="combobox"` on Select component
   - Export: Has customer select with "+ Add New Customer" option

## How to Sync Features

### Step 1: Identify the Feature Location in Live Version
Look in `src/components/MasterData/AEBF/BudgetTab.js`:
- **UI Elements**: Look in JSX return statement (lines 1700+)
- **Event Handlers**: Look for `handle*` functions (e.g., `handleDeleteBudget`)
- **State Management**: Look for `useState` hooks at top of component
- **API Calls**: Look for `axios.post/get/delete` calls

### Step 2: Find Equivalent Location in Export Template
Open `server/routes/aebf.js` and find the `/export-html-budget-form` endpoint (line ~2333):
- **HTML Structure**: Look in template literals starting with `` const html = ` ``
- **CSS Styles**: Look in `<style>` section (lines 2400-2650)
- **JavaScript**: Look in `<script>` section (lines 2876+)
- **Event Handlers**: Look for `addEventListener` or inline `onclick`

### Step 3: Adapt React Code to Vanilla JavaScript

#### Example 1: Adding Dynamic Text
**Live (React):**
```jsx
<span>Actual Volume {htmlFilters.actualYear} (MT)</span>
```

**Export (HTML Template):**
```javascript
<span>Actual ${actualYear} Volume (MT)</span>
```

#### Example 2: Adding Event Handler
**Live (React):**
```jsx
<Button onClick={handleDeleteBudget}>Delete Budget</Button>

const handleDeleteBudget = async () => {
  const response = await axios.delete(`/api/budget-draft/delete-final/${division}/${salesRep}/${budgetYear}`);
};
```

**Export (HTML):**
```javascript
// In HTML template:
<button id="deleteBudgetBtn">Delete Budget</button>

// In <script> section:
document.getElementById('deleteBudgetBtn').addEventListener('click', async function() {
  // NOTE: Can't make API calls from offline HTML file!
  alert('Delete budget feature only available in live version');
});
```

#### Example 3: Adding Searchable Dropdown
**Live (React with Ant Design):**
```jsx
<Select
  showSearch
  filterOption={(input, option) =>
    option.label.toLowerCase().includes(input.toLowerCase())
  }
>
  {options.map(opt => <Option value={opt} label={opt}>{opt}</Option>)}
</Select>
```

**Export (Vanilla JS):**
```javascript
// Add this function:
function makeSelectSearchable(selectElement) {
  selectElement.addEventListener('keypress', function(e) {
    const searchChar = e.key.toLowerCase();
    const options = Array.from(this.options);
    const match = options.find(opt => 
      opt.text.toLowerCase().startsWith(searchChar)
    );
    if (match) this.value = match.value;
  });
}

// Call it for each select:
makeSelectSearchable(document.querySelector('.customer-select'));
```

## Critical Differences Between Versions

| Feature | Live Version (React) | Export Version (HTML) |
|---------|---------------------|----------------------|
| **Data Source** | Real-time from database via API | Snapshot at export time |
| **Interactivity** | Full React state management | Vanilla JavaScript only |
| **API Calls** | Yes (axios) | No (offline file) |
| **Form Libraries** | Ant Design components | Plain HTML elements |
| **Validation** | Frontend + Backend | JavaScript only |
| **Auto-save** | Yes (30s interval) | Manual save to file |

## Features That CANNOT Be Synced

Some features only work in the Live Version:
1. **Delete Budget Button** - Requires database access
2. **Real-time Validation** - Requires backend API
3. **Auto-save to Database** - Requires network connection
4. **Load Existing Draft** - Requires database query
5. **Customer/Country/Product Lists** - Export uses snapshot from export time

For these features, add a note in the Export HTML:
```html
<div style="color: #ff4d4f; padding: 10px; background: #fff2e8;">
  ⚠️ This feature is only available in the live version
</div>
```

## Testing Checklist

After syncing features, test BOTH versions:

### Live Version Tests
- [ ] Feature works in browser at http://localhost:3000
- [ ] API calls succeed with 200 status
- [ ] Data saves to database correctly
- [ ] UI updates reflect database state

### Export Version Tests
- [ ] Export HTML file downloads successfully
- [ ] Open HTML file in browser (double-click)
- [ ] Feature works WITHOUT internet connection
- [ ] JavaScript console has no errors (F12)
- [ ] All dropdowns populate correctly
- [ ] Save Draft creates downloadable HTML
- [ ] Save Final creates downloadable HTML with data

## Common Mistakes to Avoid

1. **❌ Forgetting to update export HTML after changing live version**
   - Always update BOTH when adding features

2. **❌ Using React-specific syntax in export HTML**
   - No JSX, no hooks, no React components
   - Use vanilla JavaScript and DOM manipulation

3. **❌ Adding API calls in export HTML**
   - Export is offline - no axios, no fetch
   - All data must be embedded at export time

4. **❌ Not testing export HTML after changes**
   - Always download and test the exported file
   - Test in different browsers (Chrome, Firefox, Edge)

5. **❌ Hardcoding values that should be dynamic**
   - Use template literals: `${actualYear}` not `2025`
   - Embed data in JavaScript: `const customers = ${JSON.stringify(customersList)}`

## Future Development Workflow

When adding a NEW feature:

1. **Design Phase**
   - Decide if feature works offline (Export) or online-only (Live)
   - Plan data requirements

2. **Implementation Phase**
   - Add feature to Live Version first
   - Test thoroughly
   - Document feature behavior

3. **Sync Phase**
   - Update Export HTML template
   - Adapt React code to vanilla JS
   - Add any required CSS

4. **Testing Phase**
   - Test Live Version
   - Export HTML and test offline
   - Compare behavior between versions

5. **Documentation Phase**
   - Update this guide
   - Add comments in code
   - Note any limitations

## File Locations Quick Reference

- **Live Version**: `src/components/MasterData/AEBF/BudgetTab.js`
- **Export Generator**: `server/routes/aebf.js` (endpoint: `/export-html-budget-form`)
- **Export Backend**: `server/routes/budget-draft.js` (endpoints: `/save-draft`, `/submit-final`)
- **Database Schema**: PostgreSQL tables `sales_rep_budget` and `sales_rep_budget_draft`

## Contact & Questions

If you're adding a complex feature and unsure how to sync it:
1. Check if similar feature exists in current code
2. Test in Live Version first
3. Use browser DevTools to debug Export HTML
4. Consider if feature should be online-only

---
**Last Updated**: November 22, 2025
**Author**: AI Assistant
**Status**: ✅ All current features synced
