import React from 'react';
import UAEDirhamSymbol from '../../dashboard/UAEDirhamSymbol';
import './CombinedTrends.css';

// Color scheme definitions (MUST MATCH ColumnConfigGrid.js exactly)
const colorSchemes = [
  { name: 'blue', label: 'Blue', primary: '#288cfa', secondary: '#103766', isDark: true },
  { name: 'green', label: 'Green', primary: '#2E865F', secondary: '#C6F4D6', isDark: true },
  { name: 'yellow', label: 'Yellow', primary: '#FFD700', secondary: '#FFFDE7', isDark: false },
  { name: 'orange', label: 'Orange', primary: '#FF6B35', secondary: '#FFE0B2', isDark: false },
  { name: 'boldContrast', label: 'Bold Contrast', primary: '#003366', secondary: '#FF0000', isDark: true }
];

// Default fallback colors in order
const defaultColors = ['#FFD700', '#288cfa', '#003366', '#91cc75', '#5470c6'];

const KPI_ROWS = [52, 54, 56];
const textColors = ['#333', '#fff', '#fff', '#fff', '#fff'];

function calcVariance(current, prev) {
  if (prev === 0) return null;
  return ((current - prev) / Math.abs(prev)) * 100;
}

const ExpencesChart = ({ tableData, selectedPeriods, computeCellValue, style, hideHeader = false }) => {
  if (!selectedPeriods || selectedPeriods.length === 0 || typeof computeCellValue !== 'function') {
    return (
      <div className="expenses-trend-container trend-no-data">
        <h2 className="trend-heading">Expenses Trend</h2>
        <p>No data available. Please select a period.</p>
      </div>
    );
  }

  const periodsToUse = selectedPeriods.slice(0, 5);
  // Use only the first KPI row index for the cards (as in your screenshot)
  const kpiRow = KPI_ROWS[0];

  // Extract data for each period
  const cards = periodsToUse.map((period, idx) => {
    const value = computeCellValue(kpiRow, period);
    const sales = computeCellValue(3, period);
    const salesVolume = computeCellValue(7, period);
    const percentOfSales = (typeof sales === 'number' && sales !== 0) ? (value / sales) * 100 : 0;
    const perKg = (typeof salesVolume === 'number' && salesVolume !== 0) ? value / salesVolume : 0;
    
    // Use period-based colors (same logic as other components)
    let color;
    if (period.customColor) {
      const scheme = colorSchemes.find(s => s.name === period.customColor);
      if (scheme) {
        color = scheme.primary;
      }
    } else {
      // Default color assignment based on month/type (same as tables)
      if (period.month === 'Q1' || period.month === 'Q2' || period.month === 'Q3' || period.month === 'Q4') {
        color = '#FF6B35'; // Orange (light red)
      } else if (period.month === 'January') {
        color = '#FFD700'; // Yellow
      } else if (period.month === 'Year') {
        color = '#288cfa'; // Blue
      } else if (period.type === 'Budget') {
        color = '#2E865F'; // Green
      } else {
        color = defaultColors[idx % defaultColors.length];
      }
    }
    
    return {
      periodName: `${period.year} ${period.isCustomRange ? period.displayName : (period.month || '')} ${period.type}`.trim(),
      value: typeof value === 'number' && !isNaN(value) ? value : 0,
      percentOfSales: percentOfSales,
      perKg: perKg,
      color: color,
      textColor: color === '#FFD700' ? '#333' : '#fff', // Dark text for yellow, white for others
    };
  });

  // Calculate variances between cards
  const variances = cards.map((card, idx) => {
    if (idx === 0) return null;
    return calcVariance(card.value, cards[idx - 1].value);
  });

  return (
    <div className="expenses-trend-container" style={style || {}}>
      {!hideHeader && (
        <h2 className="trend-heading">Expenses Trend</h2>
      )}

      <div className="trend-cards-row">
        {cards.map((card, idx) => (
          <React.Fragment key={card.periodName}>
            {/* Card */}
            <div 
              className="trend-card"
              style={{
                backgroundColor: card.color,
                borderColor: card.color,
                color: card.textColor,
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.transform = 'translateY(-5px) scale(1.05)';
                e.currentTarget.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.transform = 'translateY(0) scale(1)';
                e.currentTarget.style.boxShadow = '0 2px 6px rgba(0,0,0,0.07)';
              }}>
              <div className="trend-card-title" style={{ color: card.textColor }}>{card.periodName}</div>
              <div className="trend-card-value" style={{ color: card.textColor }}>
                <UAEDirhamSymbol style={{ color: card.textColor, fontSize: 22 }} />
                {card.value ? (card.value / 1000000).toFixed(2) + 'M' : '0.00M'}
              </div>
              <div className="trend-card-metrics" style={{ color: card.textColor }}>
                <div>{card.percentOfSales.toFixed(1)}%/Sls</div>
                <div>
                  <UAEDirhamSymbol style={{ color: card.textColor, fontSize: 12 }} />
                  {card.perKg.toFixed(1)}/kg
                </div>
              </div>
            </div>
            {/* Variance badge between cards or spacer after last card */}
            {idx < cards.length - 1 ? (
              <div className="trend-connector">
                {variances[idx + 1] === null || isNaN(variances[idx + 1]) ? (
                  <span className="trend-variance-na">N/A</span>
                ) : (
                  <>
                    <span className={`trend-variance-arrow ${variances[idx + 1] > 0 ? 'trend-variance-positive' : variances[idx + 1] < 0 ? 'trend-variance-negative' : 'trend-variance-neutral'}`}>
                      {variances[idx + 1] > 0 ? '▲' : variances[idx + 1] < 0 ? '▼' : '–'}
                    </span>
                    <span className={`trend-variance-value ${variances[idx + 1] > 0 ? 'trend-variance-positive' : variances[idx + 1] < 0 ? 'trend-variance-negative' : 'trend-variance-neutral'}`}>
                      {Math.abs(variances[idx + 1]).toFixed(1)}
                    </span>
                    <span className={`trend-variance-percent ${variances[idx + 1] > 0 ? 'trend-variance-positive' : variances[idx + 1] < 0 ? 'trend-variance-negative' : 'trend-variance-neutral'}`}>
                      %
                    </span>
                  </>
                )}
              </div>
            ) : (
              <div className="trend-spacer"></div>
            )}
          </React.Fragment>
        ))}
      </div>
    </div>
  );
};

export default ExpencesChart; 